/***************************************************************************
 *
 * Project:  OpenCPN
 *
 ***************************************************************************
 * Copyright (C) 2010 by David S. Register                                 *
 *                                                                         *
 * This program is free software; you can redistribute it and/or modify    *
 * it under the terms of the GNU General Public License as published by    *
 * the Free Software Foundation; either version 2 of the License, or       *
 * (at your option) any later version.                                     *
 *                                                                         *
 * This program is distributed in the hope that it will be useful,         *
 * but WITHOUT ANY WARRANTY; without even the implied warranty of          *
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the           *
 * GNU General Public License for more details.                            *
 *                                                                         *
 * You should have received a copy of the GNU General Public License       *
 * along with this program; if not, write to the                           *
 * Free Software Foundation, Inc.,                                         *
 * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301,  USA.           *
 **************************************************************************/

#include "X11FontPicker.h"

#include <wx/fontdlg.h>
#include <wx/fontenum.h>
#include <wx/encinfo.h>
#include <wx/fontutil.h>

#ifdef __WXX11__ // FIXME: platform dependencies through build process not preprocessor

#include "/usr/X11R6/include/X11/Xlib.h"

class MyFontPreviewer : public wxWindow
{
		DECLARE_EVENT_TABLE()
	public:
		MyFontPreviewer(wxWindow * parent, const wxSize & sz = wxDefaultSize);

	private:
		void OnPaint(wxPaintEvent& event);
};

BEGIN_EVENT_TABLE(MyFontPreviewer, wxWindow)
	EVT_PAINT(MyFontPreviewer::OnPaint)
END_EVENT_TABLE()

MyFontPreviewer(::MyFontPreviewer(wxWindow * parent, const wxSize & sz = wxDefaultSize)
	: wxWindow(parent, wxID_ANY, wxDefaultPosition, sz)
{}

void MyFontPreviewer::OnPaint(wxPaintEvent& WXUNUSED(event))
{
	wxPaintDC dc(this);

	wxSize size = GetSize();
	wxFont font = GetFont();

	dc.SetPen(*wxBLACK_PEN);
	dc.SetBrush(*wxWHITE_BRUSH);
	dc.DrawRectangle(0, 0, size.x, size.y);

	if (font.Ok()) {
		dc.SetFont ( font );
		// Calculate vertical centre
		long w, h;
		dc.GetTextExtent ( wxT ( "X" ), &w, &h );
		dc.SetTextForeground ( GetForegroundColour() );
		dc.SetClippingRegion ( 2, 2, size.x-4, size.y-4 );
		dc.DrawText ( GetName(), 10, size.y/2 - h/2 );
		dc.DestroyClippingRegion();
	}
}

IMPLEMENT_DYNAMIC_CLASS(X11FontPicker, wxDialog)

BEGIN_EVENT_TABLE(X11FontPicker, wxDialog)
	EVT_CHECKBOX(wxID_FONT_UNDERLINE, X11FontPicker::OnChangeFont)
	EVT_CHOICE(wxID_FONT_STYLE, X11FontPicker::OnChangeFont)
	EVT_CHOICE(wxID_FONT_WEIGHT, X11FontPicker::OnChangeFont)
	EVT_CHOICE(wxID_FONT_FAMILY, X11FontPicker::OnChangeFace)
	EVT_CHOICE(wxID_FONT_COLOUR, X11FontPicker::OnChangeFont)
	EVT_CHOICE(wxID_FONT_SIZE, X11FontPicker::OnChangeFont)
	EVT_CLOSE(X11FontPicker::OnCloseWindow)
END_EVENT_TABLE()

#define SCALEABLE_SIZES 11
	static wxString scaleable_pointsize[SCALEABLE_SIZES] =
{
	wxT ( "6" ),
	wxT ( "8" ),
	wxT ( "10" ),
	wxT ( "12" ),
	wxT ( "14" ),
	wxT ( "16" ),
	wxT ( "18" ),
	wxT ( "20" ),
	wxT ( "24" ),
	wxT ( "30" ),
	wxT ( "36" )
};

#define NUM_COLS 48
static wxString wxColourDialogNames[NUM_COLS]= {wxT ( "ORANGE" ),
	wxT ( "GOLDENROD" ),
	wxT ( "WHEAT" ),
	wxT ( "SPRING GREEN" ),
	wxT ( "SKY BLUE" ),
	wxT ( "SLATE BLUE" ),
	wxT ( "MEDIUM VIOLET RED" ),
	wxT ( "PURPLE" ),

	wxT ( "RED" ),
	wxT ( "YELLOW" ),
	wxT ( "MEDIUM SPRING GREEN" ),
	wxT ( "PALE GREEN" ),
	wxT ( "CYAN" ),
	wxT ( "LIGHT STEEL BLUE" ),
	wxT ( "ORCHID" ),
	wxT ( "LIGHT MAGENTA" ),

	wxT ( "BROWN" ),
	wxT ( "YELLOW" ),
	wxT ( "GREEN" ),
	wxT ( "CADET BLUE" ),
	wxT ( "MEDIUM BLUE" ),
	wxT ( "MAGENTA" ),
	wxT ( "MAROON" ),
	wxT ( "ORANGE RED" ),

	wxT ( "FIREBRICK" ),
	wxT ( "CORAL" ),
	wxT ( "FOREST GREEN" ),
	wxT ( "AQUARAMINE" ),
	wxT ( "BLUE" ),
	wxT ( "NAVY" ),
	wxT ( "THISTLE" ),
	wxT ( "MEDIUM VIOLET RED" ),

	wxT ( "INDIAN RED" ),
	wxT ( "GOLD" ),
	wxT ( "MEDIUM SEA GREEN" ),
	wxT ( "MEDIUM BLUE" ),
	wxT ( "MIDNIGHT BLUE" ),
	wxT ( "GREY" ),
	wxT ( "PURPLE" ),
	wxT ( "KHAKI" ),

	wxT ( "BLACK" ),
	wxT ( "MEDIUM FOREST GREEN" ),
	wxT ( "KHAKI" ),
	wxT ( "DARK GREY" ),
	wxT ( "SEA GREEN" ),
	wxT ( "LIGHT GREY" ),
	wxT ( "MEDIUM SLATE BLUE" ),
	wxT ( "WHITE" )
};


void X11FontPicker::Init()
{
	m_useEvents = false;
	m_previewer = NULL;
	Create ( m_parent );
}

X11FontPicker::~X11FontPicker()
{
}

void X11FontPicker::OnCloseWindow ( wxCloseEvent& WXUNUSED ( event ) )
{
	EndModal ( wxID_CANCEL );
}

bool X11FontPicker::DoCreate ( wxWindow *parent )
{
	if (!wxDialog::Create(parent , wxID_ANY , _T ( "Choose Font" ) , wxDefaultPosition, wxDefaultSize, wxDEFAULT_DIALOG_STYLE,
				_T ( "fontdialog" ) ) )
	{
		wxFAIL_MSG ( wxT ( "wxFontDialog creation failed" ) );
		return false;
	}

	InitializeAllAvailableFonts();
	InitializeFont();
	CreateWidgets();

	// sets initial font in preview area
	wxCommandEvent dummy;
	OnChangeFont ( dummy );

	return true;
}

int X11FontPicker::ShowModal()
{
	int ret = wxDialog::ShowModal();

	if ( ret != wxID_CANCEL ) {
		dialogFont = *pPreviewFont;
		m_fontData.m_chosenFont = dialogFont;
	}

	return ret;
}

void X11FontPicker::InitializeAllAvailableFonts()
{
	// get the Array of all fonts facenames
	wxString pattern;
	pattern.Printf ( wxT ( "-*-*-*-*-*-*-*-*-*-*-*-*-iso8859-1" ) );

	int nFonts;
	char ** list = XListFonts ( ( Display * ) wxGetDisplay(), pattern.mb_str(), 32767, &nFonts );

	pFaceNameArray = new wxArrayString;
	unsigned int jname;
	for ( int i=0; i < nFonts; i++ ) {
		wxStringTokenizer st ( wxString ( list[i] ), _T ( "-" ) );
		st.GetNextToken();
		st.GetNextToken();
		wxString facename = st.GetNextToken();
		for ( jname=0; jname<pFaceNameArray->size(); jname++ ) {
			if ( facename == pFaceNameArray->Item ( jname ) )
				break;
		}
		if ( jname >= pFaceNameArray->size() ) {
			pFaceNameArray->Add ( facename );
		}
	}
}

// This should be application-settable
static bool ShowToolTips()
{
	return false;
}

void X11FontPicker::CreateWidgets()
{
	// layout

	bool is_pda = ( wxSystemSettings::GetScreenType() <= wxSYS_SCREEN_PDA );
	int noCols, noRows;
	if (is_pda) {
		noCols = 2;
		noRows = 3;
	} else {
		noCols = 3;
		noRows = 2;
	}

	wxBoxSizer* itemBoxSizer2 = new wxBoxSizer ( wxVERTICAL );
	this->SetSizer ( itemBoxSizer2 );
	this->SetAutoLayout ( TRUE );

	wxBoxSizer* itemBoxSizer3 = new wxBoxSizer ( wxVERTICAL );
	itemBoxSizer2->Add ( itemBoxSizer3, 1, wxEXPAND|wxALL, 5 );

	wxFlexGridSizer* itemGridSizer4 = new wxFlexGridSizer ( noRows, noCols, 0, 0 );
	itemBoxSizer3->Add ( itemGridSizer4, 0, wxEXPAND, 5 );

	wxBoxSizer* itemBoxSizer5 = new wxBoxSizer ( wxVERTICAL );
	itemGridSizer4->Add ( itemBoxSizer5, 0, wxALIGN_CENTER_HORIZONTAL|wxEXPAND, 5 );
	wxStaticText* itemStaticText6 = new wxStaticText ( this, wxID_STATIC, _ ( "&Font family:" ),
			wxDefaultPosition, wxDefaultSize, 0 );
	itemBoxSizer5->Add ( itemStaticText6, 0, wxALIGN_LEFT|wxLEFT|wxRIGHT|wxTOP|wxADJUST_MINSIZE, 5 );

	wxChoice* itemChoice7 = new wxChoice ( this, wxID_FONT_FAMILY, wxDefaultPosition,
			wxDefaultSize, *pFaceNameArray, 0 );
	itemChoice7->SetHelpText ( _ ( "The font family." ) );
	if ( ShowToolTips() )
		itemChoice7->SetToolTip ( _ ( "The font family." ) );
	itemBoxSizer5->Add ( itemChoice7, 0, wxALIGN_LEFT|wxALL, 5 );

	wxBoxSizer* itemBoxSizer8 = new wxBoxSizer ( wxVERTICAL );
	itemGridSizer4->Add ( itemBoxSizer8, 0, wxALIGN_CENTER_HORIZONTAL|wxEXPAND, 5 );
	wxStaticText* itemStaticText9 = new wxStaticText ( this, wxID_STATIC, _ ( "&Style:" ), wxDefaultPosition, wxDefaultSize, 0 );
	itemBoxSizer8->Add ( itemStaticText9, 0, wxALIGN_LEFT|wxLEFT|wxRIGHT|wxTOP|wxADJUST_MINSIZE, 5 );

	wxChoice* itemChoice10 = new wxChoice ( this, wxID_FONT_STYLE, wxDefaultPosition, wxDefaultSize );
	itemChoice10->SetHelpText ( _ ( "The font style." ) );
	if ( ShowToolTips() )
		itemChoice10->SetToolTip ( _ ( "The font style." ) );
	itemBoxSizer8->Add ( itemChoice10, 0, wxALIGN_LEFT|wxALL, 5 );

	wxBoxSizer* itemBoxSizer11 = new wxBoxSizer ( wxVERTICAL );
	itemGridSizer4->Add ( itemBoxSizer11, 0, wxALIGN_CENTER_HORIZONTAL|wxEXPAND, 5 );
	wxStaticText* itemStaticText12 = new wxStaticText ( this, wxID_STATIC, _ ( "&Weight:" ), wxDefaultPosition, wxDefaultSize, 0 );
	itemBoxSizer11->Add ( itemStaticText12, 0, wxALIGN_LEFT|wxLEFT|wxRIGHT|wxTOP|wxADJUST_MINSIZE, 5 );

	wxChoice* itemChoice13 = new wxChoice ( this, wxID_FONT_WEIGHT, wxDefaultPosition, wxDefaultSize );
	itemChoice13->SetHelpText ( _ ( "The font weight." ) );
	if ( ShowToolTips() )
		itemChoice13->SetToolTip ( _ ( "The font weight." ) );
	itemBoxSizer11->Add ( itemChoice13, 0, wxALIGN_LEFT|wxALL, 5 );

	wxBoxSizer* itemBoxSizer14 = new wxBoxSizer ( wxVERTICAL );
	itemGridSizer4->Add ( itemBoxSizer14, 0, wxALIGN_CENTER_HORIZONTAL|wxEXPAND, 5 );
	if ( m_fontData.GetEnableEffects() )
	{
		wxStaticText* itemStaticText15 = new wxStaticText ( this, wxID_STATIC, _ ( "C&olour:" ),
				wxDefaultPosition, wxDefaultSize, 0 );
		itemBoxSizer14->Add ( itemStaticText15, 0, wxALIGN_LEFT|wxLEFT|wxRIGHT|wxTOP|wxADJUST_MINSIZE, 5 );

		wxSize colourSize = wxDefaultSize;
		if ( is_pda )
			colourSize.x = 100;

		wxChoice* itemChoice16 = new wxChoice ( this, wxID_FONT_COLOUR, wxDefaultPosition,
				colourSize, NUM_COLS, wxColourDialogNames, 0 );
		itemChoice16->SetHelpText ( _ ( "The font colour." ) );
		if ( ShowToolTips() )
			itemChoice16->SetToolTip ( _ ( "The font colour." ) );
		itemBoxSizer14->Add ( itemChoice16, 0, wxALIGN_LEFT|wxALL, 5 );
	}

	wxBoxSizer* itemBoxSizer17 = new wxBoxSizer ( wxVERTICAL );
	itemGridSizer4->Add ( itemBoxSizer17, 0, wxALIGN_CENTER_HORIZONTAL|wxEXPAND, 5 );
	wxStaticText* itemStaticText18 = new wxStaticText ( this, wxID_STATIC, _ ( "&Point size:" ),
			wxDefaultPosition, wxDefaultSize, 0 );
	itemBoxSizer17->Add ( itemStaticText18, 0, wxALIGN_LEFT|wxLEFT|wxRIGHT|wxTOP|wxADJUST_MINSIZE, 5 );

	wxChoice *pc = new wxChoice ( this, wxID_FONT_SIZE, wxDefaultPosition, wxDefaultSize );
	pc->SetHelpText ( _ ( "The font point size." ) );
	if ( ShowToolTips() )
		pc->SetToolTip ( _ ( "The font point size." ) );
	itemBoxSizer17->Add ( pc, 0, wxALIGN_LEFT|wxALL, 5 );

	if ( m_fontData.GetEnableEffects() )
	{
		wxBoxSizer* itemBoxSizer20 = new wxBoxSizer ( wxVERTICAL );
		itemGridSizer4->Add ( itemBoxSizer20, 0, wxALIGN_LEFT|wxALIGN_CENTER_VERTICAL, 5 );
		wxCheckBox* itemCheckBox21 = new wxCheckBox ( this, wxID_FONT_UNDERLINE, _ ( "&Underline" ),
				wxDefaultPosition, wxDefaultSize, 0 );
		itemCheckBox21->SetValue ( FALSE );
		itemCheckBox21->SetHelpText ( _ ( "Whether the font is underlined." ) );
		if ( ShowToolTips() )
			itemCheckBox21->SetToolTip ( _ ( "Whether the font is underlined." ) );
		itemBoxSizer20->Add ( itemCheckBox21, 0, wxALIGN_LEFT|wxALL, 5 );
	}

	if ( !is_pda )
		itemBoxSizer3->Add ( 5, 5, 0, wxALIGN_CENTER_HORIZONTAL|wxALL, 5 );

	wxStaticText* itemStaticText23 = new wxStaticText ( this, wxID_STATIC, _ ( "Preview:" ), wxDefaultPosition, wxDefaultSize, 0 );
	itemBoxSizer3->Add ( itemStaticText23, 0, wxALIGN_LEFT|wxLEFT|wxRIGHT|wxTOP|wxADJUST_MINSIZE, 5 );

	MyFontPreviewer* itemWindow24 = new MyFontPreviewer ( this, wxSize ( 400, 80 ) );
	m_previewer = itemWindow24;
	itemWindow24->SetHelpText ( _ ( "Shows the font preview." ) );
	if ( ShowToolTips() )
		itemWindow24->SetToolTip ( _ ( "Shows the font preview." ) );
	itemBoxSizer3->Add ( itemWindow24, 0, wxEXPAND, 5 );

	wxBoxSizer* itemBoxSizer25 = new wxBoxSizer ( wxHORIZONTAL );
	itemBoxSizer3->Add ( itemBoxSizer25, 0, wxEXPAND, 5 );
	itemBoxSizer25->Add ( 5, 5, 1, wxEXPAND|wxALL, 5 );

	wxButton* itemButton28 = new wxButton ( this, wxID_CANCEL, _ ( "&Cancel" ), wxDefaultPosition, wxDefaultSize, 0 );
	if ( ShowToolTips() )
		itemButton28->SetToolTip ( _ ( "Click to cancel the font selection." ) );
	itemBoxSizer25->Add ( itemButton28, 0, wxALIGN_CENTER_VERTICAL|wxALL, 5 );

	wxButton* itemButton27 = new wxButton ( this, wxID_OK, _ ( "&OK" ), wxDefaultPosition, wxDefaultSize, 0 );
	itemButton27->SetDefault();
	itemButton27->SetHelpText ( _ ( "Click to confirm the font selection." ) );
	if ( ShowToolTips() )
		itemButton27->SetToolTip ( _ ( "Click to confirm the font selection." ) );
	itemBoxSizer25->Add ( itemButton27, 0, wxALIGN_CENTER_VERTICAL|wxALL, 5 );

	familyChoice = ( wxChoice* ) FindWindow ( wxID_FONT_FAMILY );
	styleChoice = ( wxChoice* ) FindWindow ( wxID_FONT_STYLE );
	weightChoice = ( wxChoice* ) FindWindow ( wxID_FONT_WEIGHT );
	colourChoice = ( wxChoice* ) FindWindow ( wxID_FONT_COLOUR );
	pointSizeChoice = ( wxChoice* ) FindWindow ( wxID_FONT_SIZE );
	underLineCheckBox = ( wxCheckBox* ) FindWindow ( wxID_FONT_UNDERLINE );

	//    Get readable font items
	wxString gotfontnative = dialogFont.GetNativeFontInfoDesc();
	wxStringTokenizer st ( gotfontnative, _T ( "-" ) );
	st.GetNextToken();
	st.GetNextToken();
	wxString facename = st.GetNextToken();
	wxString weight = st.GetNextToken();
	st.GetNextToken();
	st.GetNextToken();
	st.GetNextToken();
	st.GetNextToken();
	wxString pointsize = st.GetNextToken();

	int ptsz = atoi ( pointsize.mb_str() );
	pointsize.Printf ( _T ( "%d" ), ptsz / 10 );

	SetChoiceOptionsFromFacename ( facename );

	familyChoice->SetStringSelection ( facename );
	weightChoice->SetStringSelection ( weight );
	pointSizeChoice->SetStringSelection ( pointsize );

	m_previewer->SetFont ( dialogFont );
	m_previewer->SetName ( _T( "ABCDEFGabcdefg12345" ) );

	// Don't block events any more
	m_useEvents = true;
}

void X11FontPicker::OnChangeFace(wxCommandEvent& WXUNUSED(event))
{
	if (!m_useEvents)
		return;

	// Capture the current selections
	wxString facename = familyChoice->GetStringSelection();
	wxString pointsize = pointSizeChoice->GetStringSelection();
	wxString weight = weightChoice->GetStringSelection();

	SetChoiceOptionsFromFacename ( facename );

	// Reset the choices
	familyChoice->SetStringSelection ( facename );
	weightChoice->SetStringSelection ( weight );
	pointSizeChoice->SetStringSelection ( pointsize );

	// And make the font change
	DoFontChange();
}

void X11FontPicker::SetChoiceOptionsFromFacename (const wxString &facename)
{
	//    Get a list of matching fonts
	char face[101];
	strncpy(face, facename.mb_str(), 100);
	face[100] = '\0';

	char pattern[100];
	sprintf( pattern, "-*-%s-*-*-*-*-*-*-*-*-*-*-iso8859-1", face);

	int nFonts;
	char ** list = XListFonts ( ( Display * ) wxGetDisplay(), pattern, 32767, &nFonts );

	//    First, look thru all the point sizes looking for "0" to indicate scaleable (e.g. TrueType) font
	bool scaleable = false;
	for ( int i=0; i < nFonts; i++ ) {
		wxStringTokenizer st ( wxString ( list[i] ), _T ( "-" ) );
		st.GetNextToken();
		st.GetNextToken();
		st.GetNextToken();
		st.GetNextToken();
		st.GetNextToken();
		st.GetNextToken();
		st.GetNextToken();
		wxString pointsize = st.GetNextToken();

		if ( pointsize.IsSameAs ( _T ( "0" ) ) ) {
			scaleable = true;
			break;
		}
	}

	// make different pointsize selections for scaleable fonts
	wxArrayString PointSizeArray;

	if ( scaleable ) {
		for ( int j=0; j < SCALEABLE_SIZES; j++ )
			PointSizeArray.Add ( scaleable_pointsize[j] );
	} else {
		//Get the Point Sizes Array
		unsigned int jname;
		for ( int i=0; i < nFonts; i++ ) {
			wxStringTokenizer st ( wxString ( list[i] ), _T ( "-" ) );
			st.GetNextToken();
			st.GetNextToken();
			st.GetNextToken();
			st.GetNextToken();
			st.GetNextToken();
			st.GetNextToken();
			st.GetNextToken();
			wxString pointsize = st.GetNextToken();
			for ( jname=0; jname<PointSizeArray.size(); jname++ ) {
				if ( pointsize == PointSizeArray.Item ( jname ) )
					break;
			}
			if ( jname >= PointSizeArray.size() ) {
				PointSizeArray.Add ( pointsize );
			}
		}
	}
	pointSizeChoice->Clear();
	pointSizeChoice->Append ( PointSizeArray );
	pointSizeChoice->SetSelection ( 0 );

	//Get the Weight Array
	wxArrayString WeightArray;
	for ( int i=0; i < nFonts; i++ ) {
		wxStringTokenizer st ( wxString ( list[i] ), _T ( "-" ) );
		st.GetNextToken();
		st.GetNextToken();
		st.GetNextToken();
		wxString weight = st.GetNextToken();
		unsigned int jname;
		for ( jname=0; jname<WeightArray.size(); jname++ )
		{
			if ( weight == WeightArray.Item ( jname ) )
				break;
		}
		if ( jname >= WeightArray.size() ) {
			WeightArray.Add ( weight );
		}
	}

	weightChoice->Clear();
	weightChoice->Append ( WeightArray );
	weightChoice->SetSelection ( 0 );

}

void X11FontPicker::InitializeFont()
{
	int fontFamily = wxSWISS;
	int fontWeight = wxNORMAL;
	int fontStyle = wxNORMAL;
	int fontSize = 12;
	bool fontUnderline = false;

	wxString fontnative;
	if (m_fontData.m_initialFont.Ok()) {
		fontnative = m_fontData.m_initialFont.GetNativeFontInfoDesc();
		fontFamily = m_fontData.m_initialFont.GetFamily();
		fontWeight = m_fontData.m_initialFont.GetWeight();
		fontStyle = m_fontData.m_initialFont.GetStyle();
		fontSize = m_fontData.m_initialFont.GetPointSize();
		fontUnderline = m_fontData.m_initialFont.GetUnderlined();
	}

	wxFont tFont = wxFont(fontSize, fontFamily, fontStyle, fontWeight, fontUnderline);
	wxFont *pdialogFont = tFont.New(fontnative);
	dialogFont = *pdialogFont;
}

void X11FontPicker::OnChangeFont(wxCommandEvent& WXUNUSED(event))
{
	if (!m_useEvents)
		return;

	DoFontChange();
}

void X11FontPicker::DoFontChange(void)
{
	wxString facename = familyChoice->GetStringSelection();
	wxString pointsize = pointSizeChoice->GetStringSelection();
	wxString weight = weightChoice->GetStringSelection();

	char font_x[200]; // FIXME: potential buffer overflow
	sprintf(font_x,"-*-%s-%s-r-normal-*-*-%s0-*-*-*-*-iso8859-1", facename.mb_str(), weight.mb_str(), pointsize.mb_str());
	wxString font_xlfd(font_x, wxConvUTF8);

	XFontStruct *test = XLoadQueryFont((Display *)wxGetDisplay(), font_xlfd.mb_str());

	if (test) {
		font_xlfd.Prepend("0;");
		wxFont *ptf = new wxFont;
		pPreviewFont = ptf->New(font_xlfd);

		m_previewer->SetName(_T("ABCDEFGabcdefg12345"));
		m_previewer->SetFont(*pPreviewFont);
		m_previewer->Refresh();
	} else {
		wxString err(_T("No Font:"));
		err.Append(font_xlfd);
		m_previewer->SetName(err);
		m_previewer->SetFont(*pPreviewFont);
		m_previewer->Refresh();
	}
}

#endif

